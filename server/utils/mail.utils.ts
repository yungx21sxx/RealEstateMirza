import nodemailer from 'nodemailer';
import {prisma} from "~~/server/service/prisma.service";

const logoSVG = `
    <svg width="158" height="35" viewBox="0 0 158 35" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12.8638 23.3687L4.72266 30.9401L8.14196 28.9862L8.71184 29.841L13.0674 25.8925L13.8001 29.3118L15.7133 27.765L16.1203 29.3118L21.8192 22.0254L23.0403 23.5723L27.233 13.8843L30.2453 20.7229L32.1992 16.8965L35.5371 23.8165L39.4448 19.868L42.4164 22.8803L44.3703 21.1706L48.8479 25.2819L40.951 13.5179L35.7813 21.0892L27.7215 8.104L16.3239 26.4217L12.8638 23.3687Z" fill="#518BFF"/>
    <path d="M5.82074 29.4783C-3.62303 -3.70152 45.4276 -12.6162 47.3001 22.3503L40.9907 12.7437L35.7803 20.2336L27.7205 7.20765L16.3636 25.6882L12.8629 22.5538C12.8629 22.5538 8.857 26.5533 5.82074 29.4783Z" fill="url(#paint0_linear_906_39)"/>
    <path d="M3.50071 32.6075L0 35.0092L4.92542 33.2588L5.57671 33.8287L10.6243 30.9386L11.4791 33.4624L13.6772 32.2819L14.2064 33.4624L20.7193 28.0485L22.1847 29.3104L27.0695 22.024L30.4888 27.1122L32.7276 24.1814L36.5946 29.3104L41.113 26.4202L44.6137 28.6184L46.7711 27.3972L52.6328 30.8165L50.3533 28.3741L45.4685 25.0769L43.4332 26.4202L40.2989 24.1407L36.1876 27.1122L32.7276 21.9019L30.6923 24.8734L27.5579 19.7852L23.121 26.9087L21.7777 25.7282L15.7939 31.2642L15.3868 30.0838L13.3923 31.2642L12.6188 28.6184L8.05978 31.5899L7.5306 30.9793L3.50071 32.6075Z" fill="#518BFF"/>
    <path d="M59.8679 17.1872H57L63.3999 2.00027H66.4049L72.9419 17.1872H69.9369L68.2182 13.0454H63.2099L64.1694 10.6027H67.206L64.8337 4.89988L59.8679 17.1872ZM86.7232 2.00027L81.5251 14.3407C80.7237 16.2382 79.3565 17.1869 77.4235 17.1869C76.5237 17.1869 75.6943 16.9391 74.9351 16.4435V14.2132C75.6802 14.7088 76.4991 14.9566 77.3918 14.9566C78.3338 14.9566 78.9347 14.5814 79.1948 13.8309L73.7332 2H76.7277L80.4707 10.8147L83.7288 2L86.7232 2.00027ZM88.5684 17.1872V2.00027H95.3165C98.3953 2.00027 99.9348 3.42686 99.9348 6.28019C99.9348 9.37413 97.8295 11.2469 93.6191 11.8982L93.2184 9.39185C95.7489 8.93165 97.0142 7.92275 97.0142 6.36512C97.0142 5.10481 96.3887 4.47472 95.1374 4.47472H91.3627V17.1871L88.5684 17.1872ZM101.748 17.1872H98.8804L105.28 2.00027H108.285L114.822 17.1872H111.817L110.099 13.0454H105.09L106.05 10.6027H109.086L106.714 4.89988L101.748 17.1872ZM131.271 2.00027V4.44291H126.948V17.1873H124.154V4.44291H119.831V2.00027H131.271ZM144.788 2.00027L139.59 14.3407C138.789 16.2382 137.422 17.1869 135.489 17.1869C134.589 17.1869 133.76 16.9391 133 16.4435V14.2132C133.745 14.7088 134.564 14.9566 135.457 14.9566C136.399 14.9566 137 14.5814 137.26 13.8309L131.798 2H134.793L138.536 10.8147L141.794 2L144.788 2.00027ZM146.634 17.1872V2.00027H153.382C156.461 2.00027 158 3.42686 158 6.28019C158 9.37413 155.895 11.2469 151.684 11.8982L151.284 9.39185C153.814 8.93165 155.079 7.92275 155.079 6.36512C155.079 5.10481 154.454 4.47472 153.203 4.47472H149.428V17.1871L146.634 17.1872Z" fill="#6E51FF"/>
    <path d="M115 9H121V12H115V9Z" fill="#6E51FF"/>
    <path d="M59.928 26.9573H62.436L61.344 24.1613L61.152 23.2253L60.96 24.1613L59.928 26.9573ZM59.52 28.1333L58.644 30.5093H57.216L60.324 22.1693H61.944L65.208 30.5093H63.804L62.88 28.1333H59.52ZM70.5021 27.4373C70.5021 27.1493 70.4781 26.8893 70.4301 26.6573C70.3901 26.4253 70.3101 26.2293 70.1901 26.0693C70.0781 25.9013 69.9181 25.7773 69.7101 25.6973C69.5021 25.6093 69.2341 25.5653 68.9061 25.5653C68.3301 25.5653 67.9101 25.7293 67.6461 26.0573C67.3901 26.3773 67.2621 26.8093 67.2621 27.3533C67.2621 27.6573 67.2821 27.9413 67.3221 28.2053C67.3621 28.4613 67.4381 28.6853 67.5501 28.8773C67.6621 29.0693 67.8221 29.2213 68.0301 29.3333C68.2461 29.4373 68.5301 29.4893 68.8821 29.4893C69.1941 29.4893 69.4541 29.4373 69.6621 29.3333C69.8701 29.2213 70.0341 29.0733 70.1541 28.8893C70.2821 28.7053 70.3701 28.4933 70.4181 28.2533C70.4741 28.0133 70.5021 27.7573 70.5021 27.4853V27.4373ZM65.9901 27.1013C65.9901 26.6613 66.0101 26.1973 66.0501 25.7093C66.0901 25.2213 66.1821 24.7573 66.3261 24.3173C66.4781 23.8773 66.6981 23.4853 66.9861 23.1413C67.2821 22.7973 67.6781 22.5453 68.1741 22.3853C68.3581 22.3293 68.5501 22.2933 68.7501 22.2773C68.9581 22.2613 69.1581 22.2413 69.3501 22.2173C69.5501 22.1933 69.7341 22.1533 69.9021 22.0973C70.0781 22.0413 70.2261 21.9453 70.3461 21.8093L71.4501 22.6853C71.2821 22.9573 71.0501 23.1493 70.7541 23.2613C70.4661 23.3733 70.1661 23.4293 69.8541 23.4293C69.4941 23.4293 69.1461 23.4653 68.8101 23.5373C68.4821 23.6093 68.2101 23.7173 67.9941 23.8613C67.5381 24.1653 67.2501 24.6413 67.1301 25.2893C67.5461 24.7373 68.1901 24.4613 69.0621 24.4613C69.9581 24.4613 70.6301 24.7173 71.0781 25.2293C71.5261 25.7413 71.7501 26.4813 71.7501 27.4493C71.7501 27.9453 71.6861 28.3893 71.5581 28.7813C71.4301 29.1733 71.2421 29.5093 70.9941 29.7893C70.7541 30.0693 70.4541 30.2853 70.0941 30.4373C69.7421 30.5813 69.3341 30.6533 68.8701 30.6533C67.9501 30.6533 67.2381 30.3573 66.7341 29.7653C66.2381 29.1653 65.9901 28.3053 65.9901 27.1853V27.1013ZM75.3998 28.3253L73.9718 30.5093H72.5198L74.7038 27.3173L72.8918 24.6773L74.0918 24.3173L75.3998 26.3213L76.6958 24.3173L77.8958 24.6773L76.0838 27.3173L78.2678 30.5093H76.8158L75.3998 28.3253ZM81.027 29.4893C81.171 29.4893 81.331 29.4613 81.507 29.4053C81.683 29.3413 81.859 29.2653 82.035 29.1773C82.211 29.0893 82.379 28.9973 82.539 28.9013C82.707 28.7973 82.855 28.7093 82.983 28.6373V28.0133H80.883C80.627 28.0133 80.431 28.0813 80.295 28.2173C80.167 28.3533 80.103 28.5493 80.103 28.8053C80.103 29.0853 80.191 29.2693 80.367 29.3573C80.543 29.4453 80.763 29.4893 81.027 29.4893ZM81.735 24.3173C82.071 24.3173 82.391 24.3653 82.695 24.4613C83.007 24.5573 83.279 24.7013 83.511 24.8933C83.751 25.0773 83.939 25.3053 84.075 25.5773C84.219 25.8493 84.291 26.1613 84.291 26.5133V29.1293C84.291 29.4013 84.315 29.6413 84.363 29.8493C84.419 30.0493 84.511 30.2693 84.639 30.5093H83.259C83.195 30.4213 83.147 30.3093 83.115 30.1733C83.083 30.0373 83.059 29.9133 83.043 29.8013C82.715 30.0413 82.375 30.2453 82.023 30.4133C81.679 30.5733 81.303 30.6533 80.895 30.6533C80.623 30.6533 80.359 30.6093 80.103 30.5213C79.855 30.4333 79.635 30.3093 79.443 30.1493C79.251 29.9813 79.095 29.7853 78.975 29.5613C78.863 29.3293 78.807 29.0733 78.807 28.7933C78.807 28.4973 78.859 28.2293 78.963 27.9893C79.067 27.7493 79.211 27.5453 79.395 27.3773C79.587 27.2093 79.807 27.0813 80.055 26.9933C80.311 26.9053 80.583 26.8613 80.871 26.8613H82.983V26.7173C82.983 26.2773 82.875 25.9613 82.659 25.7693C82.451 25.5773 82.143 25.4773 81.735 25.4693C81.367 25.4693 81.043 25.5093 80.763 25.5893C80.491 25.6613 80.203 25.7773 79.899 25.9373L79.335 24.9653C79.727 24.7413 80.111 24.5773 80.487 24.4733C80.863 24.3693 81.279 24.3173 81.735 24.3173ZM85.4981 25.1813C85.7301 24.8693 86.0261 24.6493 86.3861 24.5213C86.7541 24.3853 87.1261 24.3173 87.5021 24.3173C87.7741 24.3173 88.0421 24.3453 88.3061 24.4013C88.5701 24.4493 88.8061 24.5413 89.0141 24.6773C89.2221 24.8053 89.3901 24.9813 89.5181 25.2053C89.6541 25.4213 89.7221 25.6973 89.7221 26.0333C89.7221 26.2893 89.6621 26.5333 89.5421 26.7653C89.4221 26.9893 89.2501 27.1653 89.0261 27.2933C89.3221 27.4293 89.5501 27.6213 89.7101 27.8693C89.8701 28.1173 89.9501 28.4053 89.9501 28.7333C89.9501 29.1093 89.8821 29.4213 89.7461 29.6693C89.6181 29.9093 89.4421 30.1053 89.2181 30.2573C88.9941 30.4013 88.7341 30.5013 88.4381 30.5573C88.1501 30.6213 87.8501 30.6533 87.5381 30.6533C87.1541 30.6533 86.7781 30.5853 86.4101 30.4493C86.0501 30.3053 85.7501 30.0813 85.5101 29.7773L86.1941 28.9373C86.3541 29.1053 86.5581 29.2413 86.8061 29.3453C87.0621 29.4413 87.3061 29.4893 87.5381 29.4893C87.9381 29.4893 88.2341 29.4253 88.4261 29.2973C88.6181 29.1693 88.7141 28.9573 88.7141 28.6613C88.7141 28.3653 88.5981 28.1693 88.3661 28.0733C88.1341 27.9773 87.8581 27.9293 87.5381 27.9293H86.9981V26.8493H87.5981C87.9101 26.8493 88.1421 26.8053 88.2941 26.7173C88.4541 26.6293 88.5341 26.4453 88.5341 26.1653C88.5341 25.9333 88.4581 25.7613 88.3061 25.6493C88.1621 25.5373 87.9181 25.4813 87.5741 25.4813C87.1021 25.4813 86.7221 25.6533 86.4341 25.9973L85.4981 25.1813ZM95.0782 30.5093V26.3573L92.5222 30.5093H91.1302V24.6533L92.4262 24.3173V28.6253L94.9942 24.4613H96.3742V30.5093H95.0782ZM99.1776 28.1573C98.6656 28.0933 98.2896 27.9133 98.0496 27.6173C97.8176 27.3133 97.7016 26.8613 97.7016 26.2613C97.7016 25.9333 97.7656 25.6573 97.8936 25.4333C98.0216 25.2013 98.1856 25.0133 98.3856 24.8693C98.5936 24.7253 98.8256 24.6213 99.0816 24.5573C99.3376 24.4933 99.5976 24.4613 99.8616 24.4613H102.874V30.5093H101.566V28.2893H100.978C100.882 28.2893 100.794 28.3053 100.714 28.3373C100.634 28.3693 100.566 28.4293 100.51 28.5173L99.6216 29.8973C99.4856 30.1053 99.2896 30.2853 99.0336 30.4373C98.7776 30.5813 98.5216 30.6533 98.2656 30.6533C98.1776 30.6533 98.0656 30.6373 97.9296 30.6053C97.8016 30.5813 97.6976 30.5493 97.6176 30.5093V29.4893C97.7536 29.4893 97.9096 29.4693 98.0856 29.4293C98.2616 29.3813 98.3936 29.2973 98.4816 29.1773L99.1776 28.1573ZM101.566 25.5773H99.9096C99.6056 25.5773 99.3816 25.6533 99.2376 25.8053C99.0936 25.9573 99.0216 26.1573 99.0216 26.4053C99.0216 26.6613 99.0856 26.8533 99.2136 26.9813C99.3416 27.1093 99.5736 27.1733 99.9096 27.1733H101.566V25.5773Z" fill="#FAAC37"/>
    <defs>
    <linearGradient id="paint0_linear_906_39" x1="57.9649" y1="17.8726" x2="3.74469" y2="20.8441" gradientUnits="userSpaceOnUse">
    <stop stop-color="#E83F2C"/>
    <stop offset="1" stop-color="#FEE71D"/>
    </linearGradient>
    </defs>
    </svg>
`

export async function sendEmailVerificationCode(email: string, code: string) {
    const transporter = nodemailer.createTransport({
        service: "gmail",
        host: "smtp.gmail.com",
        port: 465,
        auth: {
            user: 'aura.tour.abkhazia@gmail.com',
            pass: 'opyc advt eszx arql',
        },
    });
    const htmlContent = `
        <div style="font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px;">
          <div style="max-width: 600px; margin: auto; background-color: #ffffff; padding: 20px; border-radius: 8px;">
            <div>
              ${logoSVG}
            </div>
            <h2 style="color: #333333;">Подтверждение электронной почты</h2>
            <p style="color: #555555;">
              Здравствуйте!
            </p>
            <p style="color: #555555;">
              Вы недавно запросили подтверждение электронной почты для вашего аккаунта. Пожалуйста, введите следующий код подтверждения на сайте:
            </p>
            <div style="margin: 20px 0;">
              <span style="font-size: 24px; color: #4CAF50; font-weight: bold;">${code}</span>
            </div>
            <p style="color: #555555;">
              Этот код действителен в течение 10 минут. Если вы не запрашивали этот код, пожалуйста, проигнорируйте это письмо.
            </p>
            <p style="color: #555555;">
              С уважением,<br/>Команда Вашего Сайта
            </p>
            <hr style="border: none; border-top: 1px solid #eeeeee; margin: 20px 0;" />
            <p style="font-size: 12px; color: #aaaaaa; text-align: center;">
              © ${new Date().getFullYear()} Аура Тур. Все права защищены.
            </p>
          </div>
        </div>
  `;
    const mailOptions = {
        from: `aura.tour.abkhazia@gmail.com`,
        to: email,
        subject: 'Код подтверждения электронной почты',
        html: htmlContent,
    };

    // Отправка письма
    try {
        await transporter.sendMail(mailOptions);
    } catch (error) {
        throw new Error('Не удалось отправить письмо с кодом подтверждения');
    }

}

export async function generateVerificationCode(userId: number): Promise<string> {
    // Генерируем код
    const code = Math.floor(100000 + Math.random() * 900000).toString();

    // Устанавливаем время истечения кода
    const expiresAt = new Date(Date.now() + 15 * 60 * 1000).toISOString();

    // Сохраняем код в базе данных
    await prisma.emailVerificationCode.create({
        data: {
            code,
            userId,
            expiresAt,
            used: false,
            attempts: 0,
            lastAttempt: new Date(0),
        },
    });

    return code;
}

